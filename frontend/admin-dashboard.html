<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="dashboard-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Assuming dashboard-styles.css exists, adding styles for new card */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="admin-profile">
                <div class="admin-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
                <div class="admin-info">
                    <h2>Admin Panel</h2>
                    <p>Welcome back</p>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                    Dashboard
                </a>
                <a href="user.html">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Users
                </a>
                <a href="docment.html">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                    Documents
                </a>
            </nav>
            <button class="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                Logout
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <h1>Dashboard Overview</h1>
                <div class="header-actions">
                    <button class="refresh-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                        Refresh Data
                    </button>
                </div>
            </header>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Credit Request Statistics</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12H9"/></svg>
                    </div>
                    <div class="card-content" id="requestStats"><div class="loading-spinner"></div></div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Most Scanned Document</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                    </div>
                    <div class="card-content" id="mostScannedDoc"><div class="loading-spinner"></div></div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Highest Credits Used</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
                    </div>
                    <div class="card-content" id="highestCredits"><div class="loading-spinner"></div></div>
                </div>

                <div class="dashboard-card1 recent-scans">
                    <div class="card-header">
                        <h3>Approve Requests</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M12 4h9"/><path d="M5 9l3 3-3 3"/><path d="M9 12H2"/></svg>
                    </div>
                    <div class="card-content" id="approveRequests"><div class="loading-spinner"></div></div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Number of Users</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
                    </div>
                    <div class="card-content"><canvas id="userChart"></canvas></div>
                </div>

                <!-- Credit Usage Statistics Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Credit Usage Statistics</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div class="card-content" id="creditStats"><div class="loading-spinner"></div></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const apiBaseUrl = 'http://localhost:3001';
        const adminToken = localStorage.getItem('adminToken');
        const headers = {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
        };

        // [decodeToken function unchanged]
        function decodeToken(token) {
            try {
                const [encodedPayload] = token.split('.');
                const payload = JSON.parse(atob(encodedPayload));
                return payload;
            } catch (error) {
                console.error('Error decoding token:', error);
                return null;
            }
        }
        // Redirect if no token or not admin
        if (!adminToken) {
            window.location.replace('adminsignin.html');
        } else {
            const decodedToken = decodeToken(adminToken);
            if (!decodedToken || decodedToken.role !== 'admin') {
                localStorage.removeItem('adminToken');
                window.location.replace('adminsignin.html');
            }
        }

        // Generic fetch function with error handling
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${apiBaseUrl}${endpoint}`, { headers });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                throw error;
            }
        }

        // Render error message for a specific container
        function renderError(containerId) {
            document.getElementById(containerId).innerHTML = `
                <div class="error-message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                    <p>Error loading data. Please try again.</p>
                </div>
            `;
        }

        // Fetch and render dashboard data with per-section error handling
        async function fetchDashboardData() {
            // Request Statistics
            try {
                const requestStats = await fetchData('/admin/request-stats');
                document.getElementById('requestStats').innerHTML = `
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Users</span>
                            <span class="stat-value">${requestStats.totalUsers || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Active Users</span>
                            <span class="stat-value">${requestStats.activeUsers || 0}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                renderError('requestStats');
            }

            // Most Scanned Document
            try {
                const docData = await fetchData('/admin/most-scanned-document');
                document.getElementById('mostScannedDoc').innerHTML = `
                    <div class="document-stat">
                        <p class="key-points">Summary: ${docData.mostScannedDocument.keyPoints.summary}</p>
                        <p class="scan-count">Scanned ${docData.mostScannedDocument.scan_count} times</p>
                    </div>
                `;
            } catch (error) {
                renderError('mostScannedDoc');
            }

            // Highest Credits Used
            try {
                const creditsData = await fetchData('/admin/highest-credits-used-users');
                document.getElementById('highestCredits').innerHTML = creditsData.users.map(user => `
                    <div class="credits-stat">
                        <p class="username">${user.username}</p>
                        <p class="credits-count">${user.total_credits_used} credits used</p>
                    </div>
                `).join('');
            } catch (error) {
                renderError('highestCredits');
            }

            // Approve Requests
            try {
                const requestsData = await fetchData('/admin/credit-reset-requests');
                document.getElementById('approveRequests').innerHTML = requestsData.requests.length ? requestsData.requests.map(request => `
                    <div class="request-item">
                        <p>User ID: ${request.user_id}</p>
                        <p>Request Date: ${new Date(request.created_at).toLocaleString()}</p>
                        <button class="approve-btn" data-user-id="${request.user_id}">Approve</button>
                        <button class="decline-btn" data-user-id="${request.user_id}">Decline</button>
                    </div>
                `).join('') : '<p>No requests found.</p>';
            } catch (error) {
                renderError('approveRequests');
            }

            // Number of Users Chart
            try {
                const usersData = await fetchData('/admin/users-per-day');
                const userCounts = usersData.usersPerDay.reduce((acc, { date, count }) => {
                    if (count !== null && date !== null) acc[date] = count;
                    return acc;
                }, {});
                const userChartCtx = document.getElementById('userChart').getContext('2d');
                new Chart(userChartCtx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(userCounts),
                        datasets: [{
                            label: 'Number of Users Per Day',
                            data: Object.values(userCounts),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            } catch (error) {
                console.error('Error rendering user chart:', error);
                // No need to overwrite the canvas, just log the error
            }

            // Credit Usage Statistics
            try {
                const creditStats = await fetchData('/admin/analytics');
                document.getElementById('creditStats').innerHTML = `
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Avg Credits/User</span>
                            <span class="stat-value">${creditStats.averageCreditsPerUser || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Credit Used</span>
                            <span class="stat-value">${creditStats.totalCreditsUsed || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Admin Apporvals</span>
                            <span class="stat-value">${creditStats.approvedRequests || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Transactions</span>
                            <span class="stat-value">${creditStats.totalTransactions || 0}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                renderError('creditStats');
            }
        }

        // Approve or decline credit reset
        async function handleCreditReset(userId, action) {
            try {
                const response = await fetch(`${apiBaseUrl}/admin/${action}-credits-reset`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ userId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                alert(`Credit reset ${action}d successfully`);

                // Refresh only the Approve Requests section immediately
                const requestsData = await fetchData('/admin/credit-reset-requests');
                document.getElementById('approveRequests').innerHTML = requestsData.requests.length ? requestsData.requests.map(request => `
                    <div class="request-item">
                        <p>User ID: ${request.user_id}</p>
                        <p>Request Date: ${new Date(request.created_at).toLocaleString()}</p>
                        <button class="approve-btn" data-user-id="${request.user_id}">Approve</button>
                        <button class="decline-btn" data-user-id="${request.user_id}">Decline</button>
                    </div>
                `).join('') : '<p>No requests found.</p>';
            } catch (error) {
                console.error(`Error ${action}ing credit reset:`, error);
                alert(`Error ${action}ing credit reset. Please try again.`);
                renderError('approveRequests');
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch(`${apiBaseUrl}/auth/logout`, { method: 'POST', headers });
            } catch (error) {
                console.error('Error during logout:', error);
            } finally {
                localStorage.removeItem('adminToken');
                window.location.replace('adminsignin.html');
            }
        }

        // Event Listeners
        document.querySelector('.refresh-btn').addEventListener('click', fetchDashboardData);
        document.querySelector('.logout-btn').addEventListener('click', logout);
        document.getElementById('approveRequests').addEventListener('click', (event) => {
            const userId = event.target.getAttribute('data-user-id');
            if (!userId) return;
            if (event.target.classList.contains('approve-btn')) {
                handleCreditReset(userId, 'approve');
            } else if (event.target.classList.contains('decline-btn')) {
                handleCreditReset(userId, 'decline');
            }
        });

        // Initial load
        fetchDashboardData();
    </script>
</body>
</html>